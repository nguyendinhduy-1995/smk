// ─── Events, Reviews, Wishlist, History, Fraud ────────────

model EventLog {
  id          String    @id @default(cuid())
  type        EventType
  actorUserId String?
  userId      String?
  orderId     String?
  partnerId   String?
  payload     Json?
  createdAt   DateTime  @default(now())

  @@index([type])
  @@index([userId])
  @@index([orderId])
  @@index([createdAt])
  @@map("event_logs")
}

enum EventType {
  VIEW_PRODUCT
  ADD_TO_CART
  REMOVE_FROM_CART
  BEGIN_CHECKOUT
  PURCHASE
  REF_CLICK
  COUPON_APPLIED
  ORDER_CONFIRMED
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_RETURNED
  ORDER_CANCELLED
  ORDER_STATUS_CHANGE
  COMMISSION_PENDING
  COMMISSION_AVAILABLE
  COMMISSION_REVERSED
  PAYOUT_REQUESTED
  PAYOUT_PAID
  PARTNER_REGISTERED
  PARTNER_APPROVED
  PARTNER_SUSPENDED
  PARTNER_REACTIVATED
}

model Review {
  id           String   @id @default(cuid())
  productId    String
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  orderId      String?  // Only allow review if order DELIVERED
  rating       Int
  title        String?
  body         String?  @db.Text
  media        Json?    // [{url, type: "image"|"video"}]
  isVerified   Boolean  @default(false)
  helpfulCount Int      @default(0)
  reportCount  Int      @default(0)
  isSpam       Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}

model Question {
  id         String   @id @default(cuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  question   String   @db.Text
  answer     String?  @db.Text
  answeredBy String?
  createdAt  DateTime @default(now())

  @@index([productId])
  @@map("questions")
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model ViewHistory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now())

  @@index([userId, viewedAt(sort: Desc)])
  @@map("view_history")
}

model PartnerRiskSignal {
  id                String         @id @default(cuid())
  partnerId         String         @unique
  partner           PartnerProfile @relation(fields: [partnerId], references: [id])
  returnRate30d     Float          @default(0)
  cancelRate30d     Float          @default(0)
  sameDeviceOrders  Int            @default(0)
  sameAddressOrders Int            @default(0)
  suspiciousIpCount Int            @default(0)
  flaggedScore      Int            @default(0)
  updatedAt         DateTime       @updatedAt

  @@map("partner_risk_signals")
}
