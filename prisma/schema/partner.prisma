// ─── Partner / Affiliate ──────────────────────────────────

model PartnerProfile {
  id          String        @id @default(cuid())
  userId      String        @unique
  user        User          @relation(fields: [userId], references: [id])
  partnerCode String        @unique
  level       PartnerLevel  @default(AFFILIATE)
  status      PartnerStatus @default(PENDING)
  bankAccount Json?
  taxInfo     Json?
  bio         String?
  storeName   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  attributions AttributionSession[]
  coupons      Coupon[]
  referrals    OrderReferral[]
  commissions  Commission[]
  walletTxs    PartnerWalletTx[]
  payouts      PayoutRequest[]
  riskSignal   PartnerRiskSignal?

  @@index([partnerCode])
  @@map("partner_profiles")
}

enum PartnerLevel {
  AFFILIATE
  AGENT
  LEADER
}

enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

model AttributionSession {
  id                String             @id @default(cuid())
  sessionId         String
  userId            String?
  partnerId         String
  partner           PartnerProfile     @relation(fields: [partnerId], references: [id])
  source            AttributionSource
  deviceFingerprint String?
  ipAddress         String?
  userAgent         String?
  firstTouch        DateTime           @default(now())
  lastTouch         DateTime           @default(now())
  expiresAt         DateTime
  referral          OrderReferral?

  @@index([sessionId])
  @@index([partnerId])
  @@index([expiresAt])
  @@index([ipAddress])
  @@map("attribution_sessions")
}

enum AttributionSource {
  REF_LINK
  COUPON
  QR
}

model Coupon {
  id             String          @id @default(cuid())
  code           String          @unique
  type           CouponType
  value          Int
  ownerPartnerId String?
  ownerPartner   PartnerProfile? @relation(fields: [ownerPartnerId], references: [id])
  usageLimit     Int?
  usageCount     Int             @default(0)
  minOrderAmount Int?
  startsAt       DateTime
  endsAt         DateTime
  isActive       Boolean         @default(true)
  orders         Order[]

  @@index([code])
  @@map("coupons")
}

enum CouponType {
  PERCENT
  FIXED
}

model OrderReferral {
  id                   String              @id @default(cuid())
  orderId              String              @unique
  order                Order               @relation(fields: [orderId], references: [id])
  partnerId            String
  partner              PartnerProfile      @relation(fields: [partnerId], references: [id])
  attributionType      AttributionType
  attributionSessionId String?             @unique
  attributionSession   AttributionSession? @relation(fields: [attributionSessionId], references: [id])

  @@index([partnerId])
  @@map("order_referrals")
}

enum AttributionType {
  COUPON
  LAST_CLICK
}
