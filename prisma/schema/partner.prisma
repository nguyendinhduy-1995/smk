// ─── Partner / Affiliate ──────────────────────────────────

model PartnerProfile {
  id          String        @id @default(cuid())
  userId      String        @unique
  user        User          @relation(fields: [userId], references: [id])
  partnerCode String        @unique
  level       PartnerLevel  @default(AFFILIATE)
  status      PartnerStatus @default(PENDING)
  bankAccount Json?
  taxInfo     Json?
  bio         String?
  storeName   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  attributions AttributionSession[]
  coupons      Coupon[]
  referrals    OrderReferral[]
  commissions  Commission[]
  walletTxs    PartnerWalletTx[]
  payouts      PayoutRequest[]
  riskSignal   PartnerRiskSignal?

  @@index([partnerCode])
  @@map("partner_profiles")
}

enum PartnerLevel {
  AFFILIATE
  AGENT
  LEADER
}

enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

model AttributionSession {
  id                String             @id @default(cuid())
  sessionId         String
  userId            String?
  partnerId         String
  partner           PartnerProfile     @relation(fields: [partnerId], references: [id])
  source            AttributionSource
  deviceFingerprint String?
  ipAddress         String?
  userAgent         String?
  firstTouch        DateTime           @default(now())
  lastTouch         DateTime           @default(now())
  expiresAt         DateTime
  referral          OrderReferral?

  @@index([sessionId])
  @@index([partnerId])
  @@index([expiresAt])
  @@index([ipAddress])
  @@map("attribution_sessions")
}

enum AttributionSource {
  REF_LINK
  COUPON
  QR
}

model Coupon {
  id               String          @id @default(cuid())
  code             String          @unique
  type             CouponType
  value            Int
  maxDiscountAmount Int?           // R4: Max discount cap for PERCENT type
  ownerPartnerId   String?
  ownerPartner     PartnerProfile? @relation(fields: [ownerPartnerId], references: [id])
  usageLimit       Int?
  usageCount       Int             @default(0)
  perUserLimit     Int?            @default(1) // R4: Max uses per user
  minOrderAmount   Int?
  startsAt         DateTime
  endsAt           DateTime
  isActive         Boolean         @default(true)
  orders           Order[]
  usages           CouponUsage[]

  @@index([code])
  @@map("coupons")
}

// R4: Track per-user coupon usage
model CouponUsage {
  id        String   @id @default(cuid())
  couponId  String
  coupon    Coupon   @relation(fields: [couponId], references: [id])
  userId    String
  orderId   String
  usedAt    DateTime @default(now())

  @@unique([couponId, userId, orderId])
  @@index([couponId, userId])
  @@map("coupon_usages")
}

enum CouponType {
  PERCENT
  FIXED
}

model OrderReferral {
  id                   String              @id @default(cuid())
  orderId              String              @unique
  order                Order               @relation(fields: [orderId], references: [id])
  partnerId            String
  partner              PartnerProfile      @relation(fields: [partnerId], references: [id])
  attributionType      AttributionType
  attributionSessionId String?             @unique
  attributionSession   AttributionSession? @relation(fields: [attributionSessionId], references: [id])

  @@index([partnerId])
  @@map("order_referrals")
}

enum AttributionType {
  COUPON
  LAST_CLICK
}
