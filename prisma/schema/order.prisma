// ─── Cart & Order ─────────────────────────────────────────

model Cart {
  id        String     @id @default(cuid())
  userId    String?    @unique
  user      User?      @relation(fields: [userId], references: [id])
  sessionId String?    @unique
  items     CartItem[]
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id            String         @id @default(cuid())
  cartId        String
  cart          Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variantId     String
  variant       ProductVariant @relation(fields: [variantId], references: [id])
  qty           Int
  priceSnapshot Int

  @@unique([cartId, variantId])
  @@map("cart_items")
}

model Order {
  id              String        @id @default(cuid())
  code            String        @unique
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  status          OrderStatus   @default(CREATED)
  subtotal        Int
  discountTotal   Int           @default(0)
  shippingFee     Int           @default(0)
  total           Int
  shippingAddress Json
  paymentMethod   PaymentMethod
  paymentStatus   PaymentStatus @default(PENDING)
  paymentRef      String?
  trackingNumber  String?
  trackingUrl     String?
  note            String?
  couponId        String?
  coupon          Coupon?       @relation(fields: [couponId], references: [id])
  deliveredAt     DateTime?     // Set when order reaches DELIVERED
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  items           OrderItem[]
  referral        OrderReferral?
  commissions     Commission[]
  statusHistory   OrderStatusHistory[]
  shipments       Shipment[]
  returnRequests  ReturnRequest[]

  @@index([userId])
  @@index([code])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  CREATED
  CONFIRMED
  PAID
  SHIPPING
  DELIVERED
  FAILED_DELIVERY
  RETURNED
  CANCELLED
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  VNPAY
  MOMO
  ZALOPAY
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

model OrderItem {
  id                String         @id @default(cuid())
  orderId           String
  order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variantId         String
  variant           ProductVariant @relation(fields: [variantId], references: [id])
  qty               Int
  price             Int
  nameSnapshot      String
  skuSnapshot       String
  prescription      Json?          // {leftSph, leftCyl, leftAxis, rightSph, rightCyl, rightAxis, pd}
  lensOptionSnapshot Json?         // {name, type, price} snapshot at purchase
  prescriptionImage String?        // URL to uploaded prescription image

  @@index([orderId])
  @@map("order_items")
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    OrderStatus
  note      String?
  createdAt DateTime    @default(now())

  @@index([orderId])
  @@map("order_status_history")
}
